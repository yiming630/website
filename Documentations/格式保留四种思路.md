在 DOCX 翻译场景中做到“100 % 格式一致”本质上是一个 **“文本替换 + 版式重建”** 问题，而不是纯粹的语言转换问题。业内可行的技术路线主要有 4 条，下面按成熟度与复杂度递增给出实现思路、优缺点和推荐场景。

--------------------------------------------------------------------
1. 直接操作 DOCX XML ―― “结构-内嵌翻译”  
--------------------------------------------------------------------
核心思想  
• DOCX 本质是一个 ZIP，文本存放在 `word/document.xml`，格式在 `styles.xml`、`document.xml` 中的 `<w:rPr>`、`<w:pPr>`、`<w:tblPr>` 等标签。  
• 解析 XML，把 **纯文本节点** 送到翻译引擎，翻译后写回原节点，不触碰任何格式属性。  

技术要点  
1. python-docx / lxml 读取并遍历所有 `<w:t>` 节点。  
2. 维护 **Run-ID → 样式映射**，保证翻译写回时 run 顺序不乱。  
3. 对含占位符（页眉、大纲编号、脚注、公式字段）要做正则排除或特殊处理。  
4. 整体流程：  
   ```
   unzip -> parse XML -> extract text runs -> translate -> inject translation -> rezip
   ```  
优点  
• 100 % 保留段落、字体、字号、颜色、表格、图片等全部版式。  
• 纯离线，无需昂贵模型。  
缺点  
• 对 “同一 run 中包含多语言混排 / 替换后长度不一致导致断行” 需要复杂的算法修补。  
• 复杂文档（批注、批量修订、内容控件）需要额外适配。

适用  
• 企业内部批量文件、法律合同、技术手册，格式规范且可接受少量边角误差。

--------------------------------------------------------------------
2. “标记保护” + LLM 翻译 ―― “AI Tag-Preserve”  
--------------------------------------------------------------------
核心思想  
• 给每个文本块加**占位符标签**（如 `<seg id="42">文本</seg>`），让 LLM 只翻译标签内部内容。  
• 翻译完成后通过正则把标签剥离，回写原 XML。  

技术要点  
1. 解析 XML → `<w:t>` 包装成自定义 tag：`<seg id=42>…</seg>`  
2. Prompt 中强调 **“不要修改任何 tag 和位置”**  
3. 回收翻译文本，解析 JSON / XML 响应，写回。

优点  
• LLM 不会破坏格式；能借助 LLM 做 “意译 + 语境理解”。  
• 无需逐行 Run 对齐，开发量低于方案 1。  
缺点  
• 长文本会迫使一次 prompt > 128 k token，需要切分并保持标签层级一致。  
• LLM 仍可能偶发漏掉/打乱标记，需要后置校验脚本。  
• 成本、速度受模型限制。

适用  
• 多语言市场营销稿、技术白皮书等需“智能翻译 + 保格式”场景。

--------------------------------------------------------------------
3. 字体-样式映射重建 ―― “格式抽取 / 格式重构”  
--------------------------------------------------------------------
核心思想  
• 把原 DOCX 的**样式层次**抽取成 JSON（标题 1-6、正文、代码块等），翻译时只输出纯文本。  
• 完成后把译文 **重新套用原样式**，并动态调整换行、分页、目录。  

技术要点  
1. FormatExtractor（文档中已规划）  
   ```
   { paragraph_index: 23,
     style: "Heading2",
     runs: [
        { text: "原文", bold: true, color:"#FF0000", fontSize:24 }
     ] }
   ```  
2. 翻译后，根据 metadata 逐段落重建，遇到 **Text-Expansion** 则自动调节行距/分页。  
3. 可结合 python-docx 的样式 API 或 UNO / LibreOffice Automation。

优点  
• 对“翻译导致文本膨胀”有更好自适应，目录、引用、交叉链接可全部刷新。  
• 便于后续在 Web 编辑器中可视化调整格式。  
缺点  
• 开发量大；需要对 Word 样式系统非常熟悉。  
• 复杂公式、Office SmartArt 仍需额外处理。

适用  
• 电子书、长篇手册等对格式一致性和后期排版有**极致要求**的场景。  
• 需要二次渲染为 PDF / EPUB 的出版级场景。

--------------------------------------------------------------------
4. 全 AI 排版（Layout-LM / Diffusion-based 版式迁移）  
--------------------------------------------------------------------
核心思想  
1. 将 DOCX 渲染为 **中间格式（HTML/CSS 或 PDF + DOM 坐标）**。  
2. 使用 **文档布局理解模型**（LayoutLMv3 / Donut 等）提取结构树。  
3. 翻译后，把每个文本框/行/块映射回原坐标，使用 **Diffusion / GAN-based typesetting** 自动重排。  

优点  
• 理论上可处理扫描 PDF、OCR、复杂图文混排。  
• 可以 AI 自动调节字符间距、断行，视觉效果最佳。  
缺点  
• 研发投入极高（需要训练 / 微调视觉-文本模型）。  
• 端到端 Pipeline 难以 Debug，可解释性差。  
• 目前产业界仅 Adobe、Canva、微软 Office AI 等拥有完整能力。  

适用  
• 高预算、海量异构文档、对视觉排版极端苛刻的 SaaS 产品。  

--------------------------------------------------------------------
🔧 建议的实施路线  
--------------------------------------------------------------------
1. **短期可落地**：  
   - 采用方案 1 + 方案 2 组合：  
     • 解析原始 XML，每个 `<w:t>` 加 `<seg>` 보호标记 → 调用 OpenRouter LLM → 回写 → zip。  
     • 配合 diff-checker 脚本，自动检测 tag 是否缺失。  
   - 开发成本低，迭代最快，能保证 98 %+ 格式保留。  

2. **中期优化**：  
   - 引入 **FormatExtractor / FormatRebuilder**（方案 3），解决文本膨胀造成的页码错位、目录失效。  
   - 可与前端编辑器联动，实现所见即所得微调。  

3. **长期规划**：  
   - 根据业务量评估是否投入 AI 版式迁移（方案 4）。如需支持扫描 PDF、杂志级排版，可引入 LayoutLM + Diffusion-based 自动排版。  

--------------------------------------------------------------------
📌 关键技术栈 & 参考项目  
--------------------------------------------------------------------
• `python-docx` / `docx4j` – 解析与写回 DOCX XML  
• `lxml` / `BeautifulSoup` – XML DOM 处理  
• `OpenAI GPT-4o / Gemini-Pro` – 支持保标签翻译  
• `layoutlmv3-base`, `Donut` – 文档布局解析  
• `diffusers`, `stable-diffusion-t2i-adapter` – AI 版式重排（高级可选）  

--------------------------------------------------------------------
🗺️ 下一步行动清单  
--------------------------------------------------------------------
1. 选定方案 1+2：  
   - [ ] 编写 `format_extractor.py`，遍历 `<w:t>`，自动插入 `<seg>` 标签。  
   - [ ] 在现有 `translator/main_openrouter.py` 增加 **tag-preserve prompt** 模式。  
   - [ ] 实现 `format_rebuilder.py` 的最小功能：run 顺序对齐 + 目录刷新。  
2. 建立 **回归测试**：上传带复杂格式的样例 DOCX，自动计算差异（Paragraph/Runs/Styles diff）。  
3. 若需求确认，启动方案 3 的深度开发并预研方案 4。

这样即可在可控成本内分阶段实现“100 % 格式保留”的翻译系统。